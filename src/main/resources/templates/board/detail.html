<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/layout}">

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/board/detail.css}">
</th:block>
<th:block layout:fragment="js">
    <script>
        $(() => {
            let btnViewComments = $(".btnViewComments"); //답글 보기 버튼

            btnViewComments.on("click", function () { //답글 보기
                let _this = $(this);

                // 현재 클릭된 버튼에 가장 가까운 부모 중에서 가장 가까운 .commentWrap을 선택
                let closestCommentWrap = $(this).closest(".commentWrap");
                let recommentWrapNo = closestCommentWrap.closest(".recommentWrap");

                let replyNo = closestCommentWrap.data("no");
                console.log("(부모)고유댓글번호: " + replyNo);
                // let childNo = recommentWrapNo.data("no");
                // console.log("답글 번호: " + childNo);

                $.ajax({
                    url: "/board/getChild",
                    type: "get",
                    data: {replyNo: replyNo},
                    dataType: "json",
                    success: function (data) {
                        data.forEach(function (obj) {
                            obj.children.forEach(function (child) {
                                console.log(child);

                                let tag = "<div class=\"recommentWrap\" data-no=\"" + child.replyNo + "\">\n" +
                                    "                                <div class=\"commentsHeader\">\n" +
                                    "                                    <a href=\"/user/detail\">\n" +
                                    "                                        <div class=\"writerProfile\">\n" +
                                    "                                            <img src=\""+ child.users.userDetail.profileImg+ "\" alt=\"\">\n" +
                                    "                                        </div>\n" +
                                    "                                        <p class=\"writerName\">" + child.users.nickname + "</p>\n" +
                                    "                                    </a>\n" +
                                    "                                </div>\n" +
                                    "                                <div class=\"commentsBody\">"+child.contents+"</div>\n" +
                                    "                            </div>";

                                _this.parents(".commentWrap").next(".recommentWrap").replaceWith(tag);
                                _this.parents(".commentWrap").next(".recommentWrap").show();

                            });
                        });
                    }
                });
            });

            $(".btnPlusComments").on("click", function () {
                console.log("답글 달기 버튼");
                let closestCommentWrap = $(this).closest(".commentWrap");
                let closestRecommentForm = closestCommentWrap.find(".recommentForm");
                closestRecommentForm.toggle();
            });

            $(".recommentBtn").on("click", function () {
                let recomment = $.trim($("#recomment").val());
                if (recomment === "") {
                    alert("답글을 작성해주세요.");
                    return false;
                }
            });

            $(".replyWrite").on("click", function () {
                console.log("댓글 작성 버튼");
                let reply = $.trim($("#reply").val());
                if (reply === "") {
                    alert("댓글을 작성해주세요.");
                    return false;
                }
            })
        });
    </script>
</th:block>
<th:block layout:fragment="container">
    <main>
        <div class="container">
            <div class="board">
                <div class="content">
                    <div class="mainTitle">
                        <div class="title">
                            <p class="subject">[[${boardDetail.board.title}]]</p>
                            <p class="boardDetailInfo">
                                <span>작성일: [[${#dates.format(boardDetail.board.regdate, 'yyyy년 MM월 dd일 HH:mm')}]] </span>
                                <span>조회수: [[${boardDetail.board.hits}]]</span>
                                <span class="wrapModify">
                                    <a th:href="@{/board/delete(boardNo=${boardDetail.board.boardNo})}">삭제</a>
                                    <a th:href="@{/board/modify(boardNo=${boardDetail.board.boardNo})}">수정</a>
                                </span>
                            </p>
                        </div>
                    </div>
                    <div class="wrapContents">
                        <div class="cate">
                                <span>
                                    <th:block th:if="${boardDetail.board.cate == 1}">카테고리 : 자유</th:block>
                                    <th:block th:if="${boardDetail.board.cate == 2}">카테고리 : 개발Q&A</th:block>
                                </span>
                        </div>
                        <div class="desc">
                            <th:block th:utext="${boardDetail.board.contents}"></th:block>
                        </div>
                    </div>
                </div>
                <br>
                <div class="wrapReply">
                    <div class="title">
                        <p>댓글</p>
                    </div>
                    <div class="reply">
                        <form action="/board/replyWrite" method="post" class="replyForm">
                            <input type="hidden" name="boardNo" th:value="${boardDetail.board.boardNo}">
                            <input type="hidden" name="userNo" th:value="${boardDetail.board.users.userNo}">
                            <textarea name="contents" id="reply" placeholder="댓글을 작성해주세요."></textarea>
                            <input type="submit" value="작성" class="btn btn-custom-add replyWrite">
                        </form>
                    </div>
                    <div class="commentsContainer">
                        <th:block th:each="reply : ${replyList}" th:if="${reply.parentReply == null}">
                            <div class="commentWrap" th:data-no="${reply.replyNo}">
                                <div class="commentsHeader">
                                    <a href="/user/detail">
                                        <div class="writerProfile">
                                            <img th:src="${reply.users.userDetail.profileImg}" alt="">
                                        </div>
                                        <p class="writerName">[[${reply.users.nickname}]]</p>
                                    </a>
                                    <p class="commentRegdate">[[${#dates.format(reply.regdate, 'yyyy년 MM월 dd일
                                        HH:mm')}]]</p>
                                </div>
                                <!-- 댓글을 화면에 출력할 때 줄바꿈 문자를 <br> 태그로 변환 -->
                                <div class="commentsBody"
                                     th:utext="${#strings.replace(reply.contents, nlString, '&lt;br /&gt;')}"></div>
                                <div class="commentsBottom">
                                    <button type="button" class="btn btn-outline-secondary btnViewComments">
                                        <i class="bi bi-chevron-down"></i>
                                        <span>답글 보기</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btnPlusComments">
                                        <span>답글 달기</span>
                                    </button>
                                </div>
                                <div class="recommentWrite">
                                    <form action="/board/replyWrite?replyNo" method="post" class="recommentForm">
                                        <input type="hidden" name="boardNo" th:value="${boardDetail.board.boardNo}">
                                        <input type="hidden" name="userNo" th:value="${boardDetail.board.users.userNo}">
                                        <textarea id="recomment" name="contents" placeholder="답글을 작성해주세요."></textarea>
                                        <input type="submit" value="작성" class="btn btn-custom-add recommentBtn">
                                    </form>
                                </div>
                            </div>
                            <div class="recommentWrap">
                            </div>
                        </th:block>
                        <!--원래 childReply 있던 자리 -->
                    </div>
                </div>
            </div>
            <aside class="detailSidebar">
                <div class="userProfile">
                    <p>[[${boardDetail.board.users.nickname}]]</p>
                    <img th:src="${boardDetail.board.users.userDetail.profileImg}" alt="">
                </div>
            </aside>
        </div>
    </main>
</th:block>

</html>